name: Manual Docker Build & Push âœ‹

on:
  workflow_dispatch:



permissions:
  contents: read
  security-events: write


jobs:
  check_build_push:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # 0. Checkout code
      # -------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------
      # 1.1 Set version (YYMMDD-release-SHORTSHA)
      # -------------------------
      - name: Set Version
        id: vars
        run: |
          # Read release version from release.yaml and strip quotes
          RELEASE_VERSION=$(yq -r '.version' release.yaml)

          # Generate build date and short commit hash
          DATE=$(date +'%y%m%d')
          SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          # Generate build date and short commit hash
          BRANCH=$(echo "${{ github.ref_name }}" | sed 's/\//_/g')
          
          # Compose final build version
          VERSION="${BRANCH}-${DATE}-${RELEASE_VERSION}-${SHA}"
          
          # Export environment variables
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV

          # Print logs
          echo "ðŸ“¦ VERSION=${VERSION}"
          echo "ðŸ·ï¸ RELEASE_VERSION=${RELEASE_VERSION}"

      # -------------------------
      # 1.2 Set DockerHub username
      # -------------------------
      - name: Set DockerHub username
        run: |
          echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_ENV
          echo "ðŸ³ DockerHub username set to ${{ secrets.DOCKERHUB_USERNAME }}"
      

      # -------------------------
      # 1.3 Set DockerHub username
      # -------------------------
      - name: Set DockerHub username
        run: |
          echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" >> $GITHUB_ENV
          echo "Set DEEPSEEK_API_KEY"

      # -------------------------
      # 1.4 Build Docker image
      # -------------------------
      - name: Build Docker image
        run: |
          docker build -f Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }} \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/django-app:latest .

      # -------------------------
      # 2. Login to Docker Hub
      # -------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------
      # 3. Scan Docker Image for Vulnerabilities
      # -------------------------
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      # -------------------------
      # 4. Push Docker image
      # -------------------------
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/django-app:latest

      - name: Send message to Slack
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \":rocket: Repository *${{ github.repository }}* received a new *${{ github.event_name }}* event!\n
            Actor: *${{ github.actor }}*\n
            Branch: *${{ github.ref_name }}*\n
            <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|View Commit>\n
            Commit Message: *${{ github.event.head_commit.message }}*\"
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}


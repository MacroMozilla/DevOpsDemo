name: Django CI & Docker Build

on:
  push:
    branches:
      - master
    paths-ignore:
      - README.md
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'

  pull_request:
    branches:
      - master
    paths-ignore:
      - README.md
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # 1. Checkout code
      # -------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------
      # 2. Ruff Lint
      # -------------------------
      - name: Ruff Lint
        uses: chartboost/ruff-action@v1

      # -------------------------
      # 3.1 install CodeQL
      # -------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      # -------------------------
      # 3.2 install CodeQL
      # -------------------------
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3


      # -------------------------
      # 4. Run Unit Tests
      # -------------------------
      - name: Run Unit Tests
        run: |
          python -m unittest discover -s tests

      - name: Install yq
        run: sudo apt-get update && sudo apt-get install -y yq

      # -------------------------
      # 5.1 Set version (YYMMDD-release-SHORTSHA)
      # -------------------------
      - name: Set Version
        id: vars
        run: |
          # 1Ô∏è‚É£ Read release version from release.yaml
          RELEASE_VERSION=$(yq '.version' release.yaml)
          
          # 2Ô∏è‚É£ Generate build date and short commit hash
          DATE=$(date +'%y%m%d')
          SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          # 3Ô∏è‚É£ Compose final build version
          VERSION="${DATE}-${RELEASE_VERSION}-${SHA}"
          
          # 4Ô∏è‚É£ Export environment variables
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV
          
          # 5Ô∏è‚É£ Print logs
          echo "üì¶ VERSION=${VERSION}"
          echo "üè∑Ô∏è RELEASE_VERSION=${RELEASE_VERSION}"

      # -------------------------
      # 5.2 Build Docker image
      # -------------------------
      - name: Build Docker image
        run: |
          docker build -f Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }} \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/django-app:latest .

      # -------------------------
      # 6. Login to Docker Hub
      # -------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------
      # 7. Push Docker image
      # -------------------------
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/django-app:latest

      - name: Send message to Slack
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \":rocket: Repository *${{ github.repository }}* received a new *${{ github.event_name }}* event!\n
            Actor: *${{ github.actor }}*\n
            Branch: *${{ github.ref_name }}*\n
            <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|View Commit>\n
            Commit Message: *${{ github.event.head_commit.message }}*\"
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}


name: Django CI & Docker Build

on:
  push:
    branches:
      - master
    paths-ignore:
      - README.md
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'

  pull_request:
    branches:
      - master
    paths-ignore:
      - README.md
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'


permissions:
  contents: read
  security-events: write


jobs:
  check_build_push:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # 1. Checkout code
      # -------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------
      # 2. Ruff Lint
      # -------------------------
      - name: Ruff Lint
        uses: chartboost/ruff-action@v1

      # -------------------------
      # 3.1 install CodeQL
      # -------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      # -------------------------
      # 3.2 install CodeQL
      # -------------------------
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3


      # -------------------------
      # 4. Set up Python
      # -------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      # -------------------------
      # 5. Install Dependencies
      # -------------------------
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -------------------------
      # 6. Run Database Migrations
      # -------------------------
      - name: Run Database Migrations
        run: |
          python manage.py makemigrations --check --dry-run
          python manage.py migrate

      # -------------------------
      # 7. Run Unit Tests with Coverage
      # -------------------------
      - name: Run Tests with Coverage
        run: |
          pytest --cov=. --cov-report=xml --cov-report=term-missing --cov-fail-under=70

      # -------------------------
      # 8. Upload Coverage Reports
      # -------------------------
      - name: Upload Coverage to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

      # -------------------------
      # 9. Security Scanning - Dependencies
      # -------------------------
      - name: Run Safety Check
        continue-on-error: true
        run: |
          safety check --json || echo "âš ï¸ Safety check found vulnerabilities"

      - name: Install yq
        run: sudo apt-get update && sudo apt-get install -y yq

      # -------------------------
      # 5.1 Set version (YYMMDD-release-SHORTSHA)
      # -------------------------
      - name: Set Version
        id: vars
        run: |
          # 1ï¸âƒ£ Read release version from release.yaml and strip quotes
          RELEASE_VERSION=$(yq -r '.version' release.yaml)

          # 2ï¸âƒ£ Generate build date and short commit hash
          DATE=$(date +'%y%m%d')
          SHA=$(echo ${{ github.sha }} | cut -c1-7)

          # 3ï¸âƒ£ Compose final build version
          VERSION="${DATE}-${RELEASE_VERSION}-${SHA}"

          # 4ï¸âƒ£ Export environment variables
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV

          # 5ï¸âƒ£ Print logs
          echo "ðŸ“¦ VERSION=${VERSION}"
          echo "ðŸ·ï¸ RELEASE_VERSION=${RELEASE_VERSION}"

      # -------------------------
      # 5.2 Set DockerHub username
      # -------------------------
      - name: Set DockerHub username
        run: |
          echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_ENV
          echo "ðŸ³ DockerHub username set to ${{ secrets.DOCKERHUB_USERNAME }}"
      

      # -------------------------
      # 5.3 Set DockerHub username
      # -------------------------
      - name: Set DockerHub username
        run: |
          echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" >> $GITHUB_ENV
          echo "Set DEEPSEEK_API_KEY"

      # -------------------------
      # 5.4 Build Docker image
      # -------------------------
      - name: Build Docker image
        run: |
          docker build -f Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }} \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/django-app:latest .

      # -------------------------
      # 6. Login to Docker Hub
      # -------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------
      # 7. Scan Docker Image for Vulnerabilities
      # -------------------------
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      # -------------------------
      # 8. Push Docker image
      # -------------------------
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/django-app:latest

      - name: Send message to Slack
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \":rocket: Repository *${{ github.repository }}* received a new *${{ github.event_name }}* event!\n
            Actor: *${{ github.actor }}*\n
            Branch: *${{ github.ref_name }}*\n
            <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|View Commit>\n
            Commit Message: *${{ github.event.head_commit.message }}*\"
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}


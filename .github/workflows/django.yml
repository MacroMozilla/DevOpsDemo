name: Django CI & Docker Build

on:
  push:
    branches:
      - master
    paths-ignore:
      - README.md
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'

  pull_request:
    branches:
      - master
    paths-ignore:
      - README.md
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # 1. Checkout code
      # -------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------
      # 2. Ruff Lint
      # -------------------------
      - name: Ruff Lint
        uses: chartboost/ruff-action@v1

      # -------------------------
      # 3. Run Unit Tests
      # -------------------------
      - name: Run Unit Tests
        run: |
          python -m unittest discover -s tests

      # -------------------------
      # 4. Set version (YYMMDD-SHORTSHA-USERNAME)
      # -------------------------
      - name: Set Version
        id: vars
        run: |
          DATE=$(date +'%y%m%d')
          SHA=$(echo ${{ github.sha }} | cut -c1-7)
          USER=${{ github.actor }}
          echo "VERSION=${DATE}-${SHA}-${USER}" >> $GITHUB_ENV

      # -------------------------
      # 5. Build Docker image
      # -------------------------
      - name: Build Docker image
        run: |
          docker build -f Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }} \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/django-app:latest .

      # -------------------------
      # 6. Login to Docker Hub
      # -------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------
      # 7. Push Docker image
      # -------------------------
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/django-app:latest

      - name: Send message to Slack
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \":rocket: Repository *${{ github.repository }}* received a new *${{ github.event_name }}* event!\n
            Actor: *${{ github.actor }}*\n
            Branch: *${{ github.ref_name }}*\n
            <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|View Commit>\n
            Commit Message: *${{ github.event.head_commit.message }}*\"
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}

#  call_lambda:
#    runs-on: ubuntu-latest
#    needs: build_and_push
#    steps:
#      - name: Configure AWS credentials
#        uses: aws-actions/configure-aws-credentials@v4
#        with:
#          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#          aws-region: us-east-1
#
#      - name: Invoke AWS Lambda
#        run: |
#          aws lambda invoke \
#            --function-name myLambdaFunction \
#            --payload '{"action":"docker_push_done"}' \
#            response.json
#          cat response.json
#
#      - name: Send notification via SES
#        run: |
#          aws ses send-email \
#            --from "noreply@mydomain.com" \
#            --destination "ToAddresses=user@example.com" \
#            --message "Subject={Data=Deployment Complete},Body={Text={Data=Your Docker image was pushed successfully.}}"

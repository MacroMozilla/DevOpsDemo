name: Django CI & Docker Build

on:
  push:
    branches:
      - master
    paths-ignore:
      - README.md
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'

  pull_request:
    branches:
      - master
    paths-ignore:
      - README.md
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TOTAL_STEPS: 7   # ç»´æŠ¤ä¸€ä¸‹æ€»æ­¥æ•°å°±å¥½
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 0) å‡†å¤‡å¯å¤ç”¨çš„è„šæœ¬ï¼ˆè·¨ step å¤ç”¨ï¼‰
      - name: Prepare Slack script
        run: |
          mkdir -p .github/scripts
          cat > .github/scripts/slack_update.sh <<'BASH'
          #!/usr/bin/env bash
          # Usage:
          #   slack_start "<title>" "<repo>" "<branch>" "<actor>" "<sha>" "<message>"
          #   slack_update <completed_steps> "<current_step_name>" <total_steps> <ts>
          #   slack_fail "<failed_step_name>" <completed_steps> <total_steps> <ts>
          set -euo pipefail

          api_post() {
            curl -s -X POST \
              -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
              -H "Content-type: application/json" \
              --data @- "https://slack.com/api/$1"
          }

          bar_done() {
            local done=$1 total=$2
            local width=10  # 10 æ ¼æ˜¾ç¤ºæ›´ç»†è…»
            local blocks=$(( done * width / total ))
            local empty=$(( width - blocks ))
            local bar=""
            for ((i=0;i<blocks;i++));  do bar+="ğŸŸ©"; done
            for ((i=0;i<empty;i++));   do bar+="â¬›"; done
            echo "$bar"
          }

          bar_fail() {
            local done=$1 total=$2
            local width=10
            local blocks=$(( done * width / total ))
            local left=$(( width - blocks ))
            local bar=""
            for ((i=0;i<blocks;i++));  do bar+="ğŸŸ©"; done
            for ((i=0;i<left;i++));    do bar+="ğŸŸ¥"; done
            echo "$bar"
          }

          slack_start() {
            local title="$1" repo="$2" branch="$3" actor="$4" sha="$5" msg="$6"
            jq -n \
              --arg channel "${SLACK_CHANNEL_ID}" \
              --arg title   "$title" \
              --arg repo    "$repo" \
              --arg branch  "$branch" \
              --arg actor   "$actor" \
              --arg sha     "$sha" \
              --arg message "$msg" \
              '{
                channel: $channel,
                text: "Pipeline started",
                blocks: [
                  { type: "header", text: { type: "plain_text", text: $title } },
                  { type: "section",
                    text: { type: "mrkdwn",
                      text: ("*Repository:* " + $repo
                             + "\n*Branch:* "  + $branch
                             + "\n*Actor:* "   + $actor
                             + "\n*Commit:* "  + $sha
                             + "\n*Message:* " + $message) } },
                  { type: "section", text: { type: "mrkdwn", text: "*Progress:* â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬› 0%" } }
                ]
              }' | api_post chat.postMessage
          }

          slack_update() {
            local done="$1" step_name="$2" total="$3" ts="$4"
            local percent=$(( done * 100 / total ))
            local bar="$(bar_done "$done" "$total")"
            jq -n \
              --arg channel "${SLACK_CHANNEL_ID}" \
              --arg ts "$ts" \
              --arg step "$step_name" \
              --arg bar "$bar" \
              --arg percent "$percent" \
              '{
                channel: $channel,
                ts: $ts,
                blocks: [
                  { type: "header", text: { type: "plain_text", text: "CI/CD Pipeline Running ğŸš€" } },
                  { type: "section",
                    text: { type: "mrkdwn",
                      text: ("*Current Step:* " + $step
                             + "\n*Progress:* " + $bar + " " + $percent + "%") } }
                ]
              }' | api_post chat.update > /dev/null
          }

          slack_fail() {
            local failed_step="$1" done="$2" total="$3" ts="$4"
            local percent=$(( done * 100 / total ))
            local bar="$(bar_fail "$done" "$total")"
            jq -n \
              --arg channel "${SLACK_CHANNEL_ID}" \
              --arg ts "$ts" \
              --arg step "$failed_step" \
              --arg bar "$bar" \
              --arg percent "$percent" \
              '{
                channel: $channel,
                ts: $ts,
                blocks: [
                  { type: "header", text: { type: "plain_text", text: "âŒ CI/CD Pipeline Failed" } },
                  { type: "section",
                    text: { type: "mrkdwn",
                      text: ("*Failed at:* " + $step
                             + "\n*Progress:* " + $bar + " " + $percent + "%") } }
                ]
              }' | api_post chat.update > /dev/null
          }
          BASH
          chmod +x .github/scripts/slack_update.sh

      # 0) å‘é€èµ·å§‹æ¶ˆæ¯ï¼Œä¿å­˜ ts
      - name: Slack Start Message
        id: slack_start
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          resp=$(.github/scripts/slack_update.sh \
            slack_start "CI/CD Pipeline Started ğŸš€" \
            "${{ github.repository }}" "${{ github.ref_name }}" \
            "${{ github.actor }}" "${{ github.sha }}" \
            "${{ github.event.head_commit.message }}")
          ts=$(echo "$resp" | jq -r '.ts')
          echo "ts=$ts" >> "$GITHUB_OUTPUT"
          echo "CURRENT_STEP=Start" >> "$GITHUB_ENV"

      # 1) Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Update Slack (1)
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          echo "CURRENT_STEP=Checkout code" >> "$GITHUB_ENV"
          .github/scripts/slack_update.sh slack_update 1 "Checkout code" $TOTAL_STEPS "${{ steps.slack_start.outputs.ts }}"

      # 2) Ruff Lint
      - name: Ruff Lint
        uses: chartboost/ruff-action@v1
      - name: Update Slack (2)
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          echo "CURRENT_STEP=Ruff Lint" >> "$GITHUB_ENV"
          .github/scripts/slack_update.sh slack_update 2 "Ruff Lint" $TOTAL_STEPS "${{ steps.slack_start.outputs.ts }}"

      # 3) Unit tests
      - name: Run Unit Tests
        run: python -m unittest discover -s tests
      - name: Update Slack (3)
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          echo "CURRENT_STEP=Run Unit Tests" >> "$GITHUB_ENV"
          .github/scripts/slack_update.sh slack_update 3 "Run Unit Tests" $TOTAL_STEPS "${{ steps.slack_start.outputs.ts }}"

      # 4) Set version
      - name: Set Version
        id: vars
        run: |
          DATE=$(date +'%y%m%d')
          SHA=$(echo ${{ github.sha }} | cut -c1-7)
          USER=${{ github.actor }}
          echo "VERSION=${DATE}-${SHA}-${USER}" >> $GITHUB_ENV
      - name: Update Slack (4)
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          echo "CURRENT_STEP=Set Version" >> "$GITHUB_ENV"
          .github/scripts/slack_update.sh slack_update 4 "Set Version" $TOTAL_STEPS "${{ steps.slack_start.outputs.ts }}"

      # 5) Build image
      - name: Build Docker image
        run: |
          docker build -f Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }} \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/django-app:latest .
      - name: Update Slack (5)
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          echo "CURRENT_STEP=Build Docker image" >> "$GITHUB_ENV"
          .github/scripts/slack_update.sh slack_update 5 "Build Docker image" $TOTAL_STEPS "${{ steps.slack_start.outputs.ts }}"

      # 6) Login Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Update Slack (6)
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          echo "CURRENT_STEP=Login to Docker Hub" >> "$GITHUB_ENV"
          .github/scripts/slack_update.sh slack_update 6 "Login to Docker Hub" $TOTAL_STEPS "${{ steps.slack_start.outputs.ts }}"

      # 7) Push image
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/django-app:${{ env.VERSION }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/django-app:latest
      - name: Update Slack (7)
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          echo "CURRENT_STEP=Push Docker image" >> "$GITHUB_ENV"
          .github/scripts/slack_update.sh slack_update 7 "Push Docker image" $TOTAL_STEPS "${{ steps.slack_start.outputs.ts }}"

      # å¤±è´¥ç»Ÿä¸€å¤„ç†ï¼ˆä¼šåœ¨ä»»æ„ step å¤±è´¥æ—¶è§¦å‘ï¼‰
      - name: Slack Failure Update
        if: failure()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          # CURRENT_STEP å°±æ˜¯å‘ç”Ÿå¤±è´¥çš„æ­¥éª¤åï¼ˆåœ¨æ¯æ­¥å¼€å§‹å‰å†™å…¥äº† $GITHUB_ENVï¼‰
          done_count=$(grep -E '^CURRENT_STEP=' "$GITHUB_ENV" -n | wc -l || true)
          .github/scripts/slack_update.sh slack_fail "${CURRENT_STEP:-Unknown step}" "$done_count" $TOTAL_STEPS "${{ steps.slack_start.outputs.ts }}"
          

#  call_lambda:
#    runs-on: ubuntu-latest
#    needs: build_and_push
#    steps:
#      - name: Configure AWS credentials
#        uses: aws-actions/configure-aws-credentials@v4
#        with:
#          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#          aws-region: us-east-1
#
#      - name: Invoke AWS Lambda
#        run: |
#          aws lambda invoke \
#            --function-name myLambdaFunction \
#            --payload '{"action":"docker_push_done"}' \
#            response.json
#          cat response.json
#
#      - name: Send notification via SES
#        run: |
#          aws ses send-email \
#            --from "noreply@mydomain.com" \
#            --destination "ToAddresses=user@example.com" \
#            --message "Subject={Data=Deployment Complete},Body={Text={Data=Your Docker image was pushed successfully.}}"
